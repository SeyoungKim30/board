<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >	
<mapper namespace="board.A03_Dao">

<select id="selectBoardList" parameterType="boardSch" resultType="board">
select b.*, rn from 
	(select b2.* , rownum rn from board b2
	WHERE 
	subject LIKE '%'||#{searchSubject, jdbcType=VARCHAR}||'%'
	) b
	where rn between 1+(30*(#{pageIndex}-1)) and (30*#{pageIndex})
order by regdte DESC
</select>

<insert id="insertBoard" parameterType="board">
    <selectKey resultType="int" keyProperty="postid" order="BEFORE">
        SELECT board_seq.nextval FROM dual
    </selectKey>    
INSERT INTO board (postid,subject,CONTENT,writer,regdte) values(#{postid},#{subject},#{content},#{writer},sysdate)
</insert>

<select id="selectBoard" parameterType="board" resultType="board">
select * from board where postid = #{postid}
</select>

<update id="updateBoard" parameterType="board" >
UPDATE board SET subject = #{subject}, CONTENT = #{content}, uptdte=sysdate WHERE postid=#{postid}
</update>

<delete id="deleteBoard" parameterType="board" >
DELETE board WHERE postid=#{postid}
</delete>

<select id="totalPage" parameterType="boardSch" resultType="int">
SELECT CEIL(COUNT(*)/30) FROM BOARD b 
	WHERE 
	subject LIKE '%'||#{searchSubject, jdbcType=VARCHAR}||'%' and
	writer LIKE '%'||#{searchWriter, jdbcType=VARCHAR}||'%'
</select>

<insert id="insertVoca" parameterType="voca">
  INSERT All 
  <foreach collection="vocaarr" item="item" >
  	INTO boardvoca(postid,voca) VALUES (#{postid},#{item})
  </foreach>
  SELECT * FROM dual
</insert>

<select id="selectRelative" parameterType="java.lang.Integer" resultType="board">
SELECT b.postid, b.SUBJECT, b.REGDTE 
FROM BOARD b , (SELECT POSTID, COUNt(voca) countvoca
						FROM boardVoca
						WHERE voca IN (
							SELECT voca
							FROM 
								(SELECT voca, COUNT(postid) countpost FROM boardVoca 
								WHERE VOCA IN (SELECT voca FROM boardVoca WHERE POSTID=#{postid}) 
								GROUP BY voca) sub1
							WHERE countpost/(SELECT COUNT(DISTINCT postID) FROM boardVoca) <![CDATA[ < ]]> =0.4
								AND countpost>1
							)
						GROUP BY POSTID ) sub3
WHERE b.POSTID = sub3.postid and b.postid!=#{postid}
ORDER BY COUNTVOCA desc
</select>

</mapper>		
		